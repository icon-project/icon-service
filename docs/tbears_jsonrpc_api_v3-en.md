JSON-RPC API v3 for ICON SCORE development tool (tbears)
=========================================

This document explains JSON-RPC APIs to interact with IconServiceEngine.

| Date | Author | Description |
|:-----|:-----:|:----|
| 2018.06.29 | Jiyun Park | API errors fixed. |
| 2018.06.12 | Chiwon Cho | Table errors fixed. |
| 2018.06.08 | Chiwon Cho | Error codes added, icx_getTransactionResult description updated. |
| 2018.05.18 | Chiwon Cho | JSON-RPC API v3 ChangeLog added |
| 2018.05.17 | Eunsoo Park | API Convention added. Document updated overally. |
| 2018.05.15 | Chiwon Cho | Initial revision. |

# API Convention
* Follows [JSON-RPC 2.0 Specification](http://www.jsonrpc.org/specification)

```json
// Request
{
    "jsonrpc": "2.0",
    "method": "$STRING1",
    "id": $INT,
    "params": {
        "$KEY1": "$VALUE1",
        "$KEY2": {
            "method": "$STRING2",
            "params": {
                "$KEY3": "$VALUE3"
            }
        }
    }
}

// Response - success
{
    "jsonrpc": "2.0",
    "id": $INT,
    "result": "$STRING"
    // or
    "result": {
      "$KEY1": "$VALUE1",
      "$KEY2": "$VALUE2"
    }
}

// Response - fail
{
    "jsonrpc": "2.0",
    "id": $INT1,
    "error": {
        "code": $INT2,
        "message": "$STRING"
    }
}
```
* "KEY" naming follows camel case.

# VALUE Types

Basically, every VALUE in JSON-RPC message is string.<br/>
Below table shows the most common "VALUE types".

| VALUE type | Description | Example |
|:----------|:----|:----|
| <a id="T_ADDR_EOA">T_ADDR_EOA</a> | "hx" + 40 digit HEX string | hxbe258ceb872e08851f1f59694dac2558708ece11 |
| <a id="T_ADDR_SCORE">T_ADDR_SCORE</a> | "cx" + 40 digit HEX string | cxb0776ee37f5b45bfaea8cff1d8232fbb6122ec32 |
| <a id="T_HASH">T_HASH</a> | "0x" + 64 digit HEX string | 0xc71303ef8543d04b5dc1ba6579132b143087c68db1b2168786408fcbce568238 |
| <a id="T_INT">T_INT</a> | "0x" + lowercase HEX string | 0xa |
| <a id="T_BIN_DATA">T_BIN_DATA</a> | "0x" + lowercase HEX string.<br>Length must be even. | 0x34b2 |
| <a id="T_SIG">T_SIG</a> | base64 encoded string | VAia7YZ2Ji6igKWzjR2YsGa2m53nKPrfK7uXYW78QLE+ATehAVZPC40szvAiA6NEU5gCYB4c4qaQzqDh2ugcHgA= |
| <a id="T_DATA_TYPE">T_DATA_TYPE</a> | "call": call SCORE's function.<br/>"deploy": install or update SCORE. | call<br/>deploy |

# JSON-RPC Error Codes

This chapter explains the error codes used in ICON JSON-RPC API response.<br/>

Belows table shows the default error messages for the error code. Actual message may vary depending on the implementation. 

## Error Codes

| Error code | Message | Description |
|:---------|:------|:-----|
| -32700 | Parse error | Invalid JSON was received by the server. An error occurred on the server while parsing the JSON text. |
| -32600 | Invalid Request | The JSON sent is not a valid Request object. |
| -32601 | Method not found | The method does not exist / is not available. |
| -32602 | Invalid params | Invalid method parameter(s). |
| -32603 | Internal error | Internal JSON-RPC error. |
| -32000 | Server error | IconServiceEngine internal error. |
| -32100 | Score error | Score internal error. |

## JSON-RPC Error Response
```json
{
    "jsonrpc": "2.0",
    "id": 1,
    "error": {
        "code": -32601,
        "message": "Method not found (transfer)"
    }
}
```

# JSON-RPC API v3 ChangeLog

* Fixed to conform to JSON-RPC 2.0 specification
    * Success response: result
    * Fail response: error
* Removed additional response generated by loopchain such as "response_code" in SCORE's JSON-PRC Response.
    * v2: "result": {"response_code": "0x0", "response": "0x12345"}
    * v3: "result": "0x12345"
* Fixed inconsistent key naming in v2 API
    * v2: icx_getBlockByHeight: "time_stamp"
    * v2: icx_sendTransaction: "timestamp"
    * v3: "timestamp"
* Fixed inconsistent VALUE format in v2 API
    * timestamp
        * v2: icx_sendTransaction: "timestamp": "1234567890"
        * v2: icx_getBlockByHeight: "timestamp": 1234567890
        * v3: "timestamp": "0x499602d2"
    * hash
        * v2: icx_getBlockByHash: "hash": "af5570f5a1810b7af78caf4bc70a660f0df51e42baf91d4de5b2328de0e83dfc"
        * v3: "hash": "0xaf5570f5a1810b7af78caf4bc70a660f0df51e42baf91d4de5b2328de0e83dfc"
* Key naming follows camel case.
    * v2: "data_type"
    * v3: "dataType"
* Removed tx_hash from the icx_sendTransaction message.

# JSON-RPC Methods

* [icx_call](#icx_call)
* [icx_getBalance](#icx_getbalance)
* [icx_getScoreApi](#icx_getscoreapi)
* [icx_getTotalSupply](#icx_gettotalsupply)
* [icx_getTransactionResult](#icx_gettransactionresult)
* [icx_sendTransaction](#icx_sendtransaction)

## icx_call

* Calls SCORE's external function.
* Does not make state transition. Read-only. 

### Parameters

| KEY | VALUE type | Description |
|:----|:-----------|:-----|
|from|[T_ADDR_EOA](#T_ADDR_EOA)|Message sender's address.|
|to|[T_ADDR_SCORE](#T_ADDR_SCORE)|SCORE address that will handle the message in the transaction.|
|dataType|[T_DATA_TYPE](#T_DATA_TYPE)|"call" is the only possible data type.|
|data| - |SCORE's function name and its parameters.|
|data.method | str | SCORE's function name. |
|data.params | T_DICT | Parameters to be passed to the function. |

### Returns

Return value of the executed SCORE function.

### Example

```json
// Request
{
    "jsonrpc": "2.0",
    "method": "icx_call",
    "id": 1234,
    "params": {
        "from": "hxbe258ceb872e08851f1f59694dac2558708ece11", // TX sender address
        "to": "cxb0776ee37f5b45bfaea8cff1d8232fbb6122ec32",   // SCORE address
        "dataType": "call", // message call
        "data": {           // message call data 
            "method": "get_balance", // SCORE external function
            "params": {
                "address": "hx1f9a3310f60a03934b917509c86442db703cbd52" // input parameter of "get_balance"
            }
        }
    }
}

// Response - success
{
    "jsonrpc": "2.0",
    "id": 1234,
    "result": "0x2961fff8ca4a62327800000"
}

// Response - fail 
{
    "jsonrpc": "2.0",
    "id": 1234,
    "error": {
        "code": -32601,
        "message": "Method not found"
    }
}

// Response - fail 
{
    "jsonrpc": "2.0",
    "id": 1234,
    "error": {
        "code": -32602,
        "message": "Invalid params"
    }
}
```

## icx_getBalance

* Queries the balance of the given EOA or SCORE.
* Does not make state transition.

### Parameters

| KEY | VALUE type | Description |
|:----|:-----------|:-----|
| address | [T_ADDR_EOA](#T_ADDR_EOA) or [T_ADDR_SCORE](#T_ADDR_SCORE) | Address of EOA or SCORE to query its balance. |

### Returns

Number of coins.

### Example

```json
// Request
{
    "jsonrpc": "2.0",
    "method": "icx_getBalance",
    "id": 1234,
    "params": {
        "address": "hxb0776ee37f5b45bfaea8cff1d8232fbb6122ec32"
    }
}

// Response - success
{
    "jsonrpc": "2.0",
    "id": 1234,
    "result": "0xde0b6b3a7640000"
}

// Response - fail
{
    "jsonrpc": "2.0",
    "id": 1234,
    "error": {
        "code": -32602,
        "message": "Invalid address"
    }
}
```

## icx_getScoreApi

* Returns SCORE's API list (external, payable, fallback, on_install, on_update, eventlog).

### Parameters

| KEY | VALUE type | Description |
|:----|:-----------|:-----|
| address | [T_ADDR_SCORE](#T_ADDR_SCORE) | SCORE adress to be examined. |

### Returns

* Fields containing information about the function
    - type : function, fallback, on_install, on_update, or eventlog
    - name : function name
    - inputs : parameters in array
        + name : parameter name
        + type : parameter type (int, str, bytes, bool, Address)
        + indexed : in the case of eventlog, tells if the parameter is indexed.
    - outputs : return value  
        + type : return value type (int, str, bytes, bool, Address)
    - readonly : external (readonly=True)
    - payable : payable

### Example

```json
// Request
{
    "jsonrpc": "2.0",
    "method": "icx_getScoreApi",
    "id": 1234,
    "params": {
        "address": "cxb0776ee37f5b45bfaea8cff1d8232fbb6122ec32"  // SCORE address
    }
}

// Response - success
{
    "jsonrpc": "2.0",
    "id": 1234,
    "result": [...]
}

// Response - fail
// same as icx_call fail 
```

## icx_getTotalSupply

* Returns total coin supply that has been issued. 
* Does not make state transition.

### Parameters
None

### Returns
Total number of coins issued.

### Example

```json
// Request
{
    "jsonrpc": "2.0",
    "method": "icx_getTotalSupply",
    "id": 1234
}

// Response - success
{
    "jsonrpc": "2.0",
    "id": 1234,
    "result": "0x2961fff8ca4a62327800000"
}
```

## icx_getTransactionResult

* Getting transaction result using txHash.

### Parameters

| KEY | VALUE type | Description |
|:----|:----------|:----- |
| txHash | [T_HASH](#T_HASH) | TX hash of the transaction to be queried. |

### Returns

| KEY | VALUE type | Description |
|:----|:----------|:-----|
| status | [T_INT](#T_INT) | 1 on success, 0 on failure. |
| failure | T_DICT | This field exists when status is 0. Contains code(str) and  message(str). |
| txHash | [T_HASH](#T_HASH) | Transaction hash |
| txIndex | [T_INT](#T_INT) | Transaction index in the block |
| blockHeight | [T_INT](#T_INT) | Height of the block that includes the transaction. |
| blockHash | [T_HASH](#T_HASH) | Hash of the block that includes the transation. |
| cumulativeStepUsed | [T_INT](#T_INT) | Total number of step used by this transaction and all preceeding transactions in the same block. |
| stepUsed | [T_INT](#T_INT) | The amount of step used by this transaction |
| scoreAddress | [T_ADDR_SCORE](#T_ADDR_SCORE) | SCORE address If the transaction created a new SCORE. (optional) |

### Example

```json
// Request
{
    "jsonrpc": "2.0",
    "method": "icx_getTransactionResult",
    "id": 1234,
    "params": {
        "txHash": "0xb903239f8543d04b5dc1ba6579132b143087c68db1b2168786408fcbce568238"
    }
}

// Response - succeeded tx
{
    "jsonrpc": "2.0",
    "id": 1234,
    "result": {
        "status": "0x1",
        "to": "cx0000000000000000000000000000000000000000",
        "txHash": "0xb903239f8543d04b5dc1ba6579132b143087c68db1b2168786408fcbce568238",
        "txIndex": "0x1",
        "blockHeight": "0x1234",
        "blockHash": "0xc71303ef8543d04b5dc1ba6579132b143087c68db1b2168786408fcbce568238",
        "cumulativeStepUsed": "0x1234",
        "stepUsed": "0x1234",
        "stepPrice": "0x5678",
        "scoreAddress": "cxb0776ee37f5b45bfaea8cff1d8232fbb6122ec32"
    }
}

// Response - failed tx
{
    "jsonrpc": "2.0",
    "id": 1234,
    "result": {
        "status": "0x0",
        "failure": {
            "code": "0x7d00",
            "message": "Out of balance"
        },
        "to": "hx5bfdb090f43a808005ffc27c25b213145e80b7cd",
        "txHash": "0xb903239f8543d04b5dc1ba6579132b143087c68db1b2168786408fcbce568238",
        "txIndex": "0x1",
        "blockHeight": "0x1234",
        "blockHash": "0xc71303ef8543d04b5dc1ba6579132b143087c68db1b2168786408fcbce568238",
        "cumulativeStepUsed": "0x1234",
        "stepUsed": "0x1234",
        "stepPrice": "0x5678"
    }
}

// Response - fail (invalid txHash was given)
{
    "jsonrpc": "2.0",
    "id": 1234,
    "error": {
        "code": -32602,
        "message": "Invalid txHash"
    }
}
```

## icx_sendTransaction

* Transfers designated amount of coins from 'from' address to 'to' address. 
* Installs a new SCORE.
* Updates the SCORE in the 'to' address.
* Invokes a function of the SCORE in the 'to' address.
* This function causes state transition.

### Parameters

| KEY | VALUE type | Required | Description |
|:----|:----------|:----:|:-----|
| version | [T_INT](#T_INT) | required | Protocol version. ("0x3" for V3) |
| from | [T_ADDR_EOA](#T_ADDR_EOA) | required | Transaction creator's address. |
| to | [T_ADDR_EOA](#T_ADDR_EOA) or<br/>[T_ADDR_SCORE](#T_ADDR_SCORE) | optional | EOA address to receive coin, or SCORE address to execute the transaction. |
| value | [T_INT](#T_INT) | optional | Amount of ICX coin to transfer to 'to address'. When ommitted, assumes 0. |
| stepLimit |[T_INT](#T_INT) | required | Maximum step allowance that can be used by the transaction. |
| timestamp | [T_INT](#T_INT) | required | Transaction send time. timestamp is in microsecond. |
| nonce | [T_INT](#T_INT) | optional | An arbitrary number used to prevent transaction hash collision. |
| signature | [T_SIG](#T_SIG) | required | Transaction signature. |
| dataType | [T_DATA_TYPE](#T_DATA_TYPE) | optional | Type of data. (call, or deploy) |
| data | N/A | optional | Contains various type of data depending on the transaction purpose. |
| data.method | str | optional | SCORE function (call) |
| data.contentType | str | optional | Content mime-type (deploy) |
| data.content | [T_BIN_DATA](#T_BIN_DATA) | optional | Binary data (deploy) |
| data.params | T_DICT | optional | Parameters to be passed to the SCORE funtion. |

### Returns

* Transaction hash ([T_HASH](#T_HASH)) on success
* Error code and message on fail

### Example

* Coin transfer

```json
// Request
{
    "jsonrpc": "2.0",
    "method": "icx_sendTransaction",
    "id": 1234,
    "params": {
        "version": "0x3",
        "from": "hxbe258ceb872e08851f1f59694dac2558708ece11",
        "to": "hx5bfdb090f43a808005ffc27c25b213145e80b7cd",
        "value": "0xde0b6b3a7640000",
        "stepLimit": "0x12345",
        "timestamp": "0x563a6cf330136",
        "nonce": "0x1",
        "signature": "VAia7YZ2Ji6igKWzjR2YsGa2m53nKPrfK7uXYW78QLE+ATehAVZPC40szvAiA6NEU5gCYB4c4qaQzqDh2ugcHgA="
    }
}
```

* SCORE function call

```json
// Request
{
    "jsonrpc": "2.0",
    "method": "icx_sendTransaction",
    "id": 1234,
    "params": {
        "version": "0x3",
        "from": "hxbe258ceb872e08851f1f59694dac2558708ece11",
        "to": "cxb0776ee37f5b45bfaea8cff1d8232fbb6122ec32",
        "stepLimit": "0x12345",
        "timestamp": "0x563a6cf330136",
        "nonce": "0x1",
        "signature": "VAia7YZ2Ji6igKWzjR2YsGa2m53nKPrfK7uXYW78QLE+ATehAVZPC40szvAiA6NEU5gCYB4c4qaQzqDh2ugcHgA=",
        "dataType": "call",
        "data": {
            "method": "transfer",
            "params": {
                "to": "hxab2d8215eab14bc6bdd8bfb2c8151257032ecd8b",
                "value": "0x1"
            }
        }
    }
}
```

* SCORE install

```json
// Request
{
    "jsonrpc": "2.0",
    "method": "icx_sendTransaction",
    "id": 1234,
    "params": {
        "version": "0x3",
        "from": "hxbe258ceb872e08851f1f59694dac2558708ece11",
        "to": "cx0000000000000000000000000000000000000000", // address 0 means SCORE install
        "stepLimit": "0x12345",
        "timestamp": "0x563a6cf330136",
        "nonce": "0x1",
        "signature": "VAia7YZ2Ji6igKWzjR2YsGa2m53nKPrfK7uXYW78QLE+ATehAVZPC40szvAiA6NEU5gCYB4c4qaQzqDh2ugcHgA=",
        "dataType": "deploy",
        "data": {
            "contentType": "application/zip",
            "content": "0x1867291283973610982301923812873419826abcdef91827319263187263a7326e...", // compressed SCORE data
            "params": {  // parameters to be passed to on_install()
                "name": "ABCToken",
                "symbol": "abc",
                "decimals": "0x12"
            }
        }
    }
}
```

* SCORE update

```json
// Request
{
    "jsonrpc": "2.0",
    "method": "icx_sendTransaction",
    "id": 1234,
    "params": {
        "version": "0x3",
        "from": "hxbe258ceb872e08851f1f59694dac2558708ece11",
        "to": "cxb0776ee37f5b45bfaea8cff1d8232fbb6122ec32", // SCORE address to be updated
        "stepLimit": "0x12345",
        "timestamp": "0x563a6cf330136",
        "nonce": "0x1",
        "signature": "VAia7YZ2Ji6igKWzjR2YsGa2m53nKPrfK7uXYW78QLE+ATehAVZPC40szvAiA6NEU5gCYB4c4qaQzqDh2ugcHgA=",
        "dataType": "deploy",
        "data": {
            "contentType": "application/zip",
            "content": "0x1867291283973610982301923812873419826abcdef91827319263187263a7326e...", // compressed SCORE data
            "params": {  // parameters to be passed to on_update()
                "amount": "0x1234"
            }
        }
    }
}
```

* Response

```json
// Response - success
{
    "jsonrpc": "2.0",
    "id": 1234,
    "result": "0x4bf74e6aeeb43bde5dc8d5b62537a33ac8eb7605ebbdb51b015c1881b45b3aed" // transaction hash
}

// Response - fail
{
    "jsonrpc": "2.0",
    "id": 1234,
    "error": {
        "code": -32600,
        "message": "Invalid signature"
    }
}

// Response - fail
{
    "jsonrpc": "2.0",
    "id": 1234,
    "error": {
        "code": -32601,
        "message": "Method not found"
    }
}
```

## References

* [jsonrpc specification](http://www.jsonrpc.org/specification)
* [Ethereum JSON RPC API](https://github.com/ethereum/wiki/wiki/JSON-RPC)
* [ICON JSON RPC API v2](https://github.com/icon-project/icx_JSON_RPC)
